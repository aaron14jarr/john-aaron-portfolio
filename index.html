<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>John Aaron â€” Portfolio (Sync)</title>
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />
<style>
:root{--bg:#eef1f5;--card:#fff;--accent:#0a6ed1;--muted:#6b7280}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui,Arial,Helvetica;background:var(--bg);color:#0b1220;padding:18px}
.hidden{display:none!important}
.container{max-width:900px;margin:14px auto}
.card{background:var(--card);border-radius:12px;padding:18px;box-shadow:0 8px 30px rgba(2,6,23,.06);margin-bottom:14px}
.hcenter{text-align:center}
.profile-pic{width:150px;height:150px;border-radius:50%;object-fit:cover;display:block;margin:0 auto}
.controls{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin-top:12px}
.btn{background:var(--accent);color:#fff;padding:10px 14px;border-radius:10px;border:none;cursor:pointer}
.btn.ghost{background:#fff;color:var(--accent);border:1px solid rgba(10,110,209,.12)}
.small{padding:8px 10px;font-size:14px}
.social-item{display:flex;align-items:center;gap:10px;margin:8px 0}
.social-item img{width:28px;height:28px;border-radius:6px}
#removeMenu{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);background:#fff;padding:14px;border-radius:10px;box-shadow:0 10px 30px rgba(0,0,0,.12);display:none;z-index:2000;width:90%;max-width:380px}
.note{color:var(--muted);font-size:13px;margin-top:8px}
.header-row{display:flex;justify-content:space-between;align-items:center;gap:12px}
.sync-indicator{font-size:13px;color:var(--muted)}
</style>
</head>
<body>
<!-- Password Screen -->
<div id="passwordScreen" style="position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:#fff;z-index:9999">
  <div style="width:100%;max-width:420px;text-align:center;padding:18px">
    <h2>WELCOME TO JOHN AARON'S PORTFOLIO</h2>
    <input id="viewPassInput" type="password" placeholder="Enter view password" style="width:100%;padding:10px;border-radius:8px;border:1px solid #ddd;margin-top:8px">
    <div style="margin-top:8px;display:flex;gap:8px;justify-content:center">
      <button id="toggleView" class="btn small btn ghost">Show</button>
      <button id="enterView" class="btn small">Enter</button>
    </div>
    <p id="viewMsg" style="color:#c0392b;height:20px;margin-top:8px"></p>
    <p class="note">View password: <b>Stellotenebris</b> (you can change later)</p>
  </div>
</div>

<main id="mainContent" class="hidden">
  <div class="container">
    <div class="card">
      <div class="header-row">
        <div style="flex:1">
          <img id="profilePic" class="profile-pic" src="" alt="Profile photo">
        </div>
        <div style="flex:1;text-align:right">
          <div class="sync-indicator" id="syncStatus">Not connected</div>
        </div>
      </div>

      <div class="controls">
        <button id="uploadPicBtn" class="btn ghost small hidden">Upload Photo</button>
        <button id="editBtn" class="btn small">Edit</button>
        <button id="doneBtn" class="btn small hidden">Done</button>
        <button id="connectSyncBtn" class="btn small ghost">Connect Sync</button>
      </div>

      <h2 style="text-align:center;margin-top:8px">JOHN AARON R. RESURRECCION</h2>
    </div>

    <div class="card">
      <h3>About Me</h3>
      <p id="aboutText">I am John Aaron R. Resurreccion, a passionate and motivated individual who loves exploring technology, creativity, and continuous learning.</p>
    </div>

    <div class="card">
      <h3>Socials</h3>
      <div id="socialList"></div>
      <div class="controls">
        <button id="addSocialBtn" class="btn small hidden">Add Social</button>
        <button id="removeSocialBtn" class="btn small ghost hidden">Remove Social</button>
      </div>
    </div>

    <div class="card">
      <h3>Contact</h3>
      <p id="contactText">Globe: 09562460068<br>Smart: 09423379576<br>Email: aaron14.jarr@gmail.com</p>
    </div>
  </div>
</main>

<!-- Remove menu -->
<div id="removeMenu">
  <h3>Select a Social to Remove</h3>
  <select id="socialSelect" style="width:100%;padding:10px;border-radius:8px;border:1px solid #e5e7eb"></select>
  <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
    <button id="confirmRemoveBtn" class="btn small">Remove</button>
    <button id="cancelRemoveBtn" class="btn small ghost">Cancel</button>
  </div>
</div>

<script>
/* Utility: SHA-256 hash */
async function hash(text){
  const enc = new TextEncoder();
  const buf = await crypto.subtle.digest('SHA-256', enc.encode(text));
  return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
}

/* Precomputed hashes for the two passwords (hashed client-side for safety) */
let VIEW_HASH = '';
let EDIT_HASH = '';

(async()=>{ VIEW_HASH = await hash('Stellotenebris'); EDIT_HASH = await hash('Johnaaron_rr04'); })();

/* Elements */
const passwordScreen = document.getElementById('passwordScreen');
const mainContent = document.getElementById('mainContent');
const viewPassInput = document.getElementById('viewPassInput');
const toggleView = document.getElementById('toggleView');
const enterView = document.getElementById('enterView');
const viewMsg = document.getElementById('viewMsg');

const editBtn = document.getElementById('editBtn');
const doneBtn = document.getElementById('doneBtn');
const uploadPicBtn = document.getElementById('uploadPicBtn');
const addSocialBtn = document.getElementById('addSocialBtn');
const removeSocialBtn = document.getElementById('removeSocialBtn');
const connectSyncBtn = document.getElementById('connectSyncBtn');
const syncStatus = document.getElementById('syncStatus');

const aboutText = document.getElementById('aboutText');
const contactText = document.getElementById('contactText');
const profilePic = document.getElementById('profilePic');
const socialList = document.getElementById('socialList');

const removeMenu = document.getElementById('removeMenu');
const socialSelect = document.getElementById('socialSelect');
const confirmRemoveBtn = document.getElementById('confirmRemoveBtn');
const cancelRemoveBtn = document.getElementById('cancelRemoveBtn');

let isEditing = false;

/* Local/Sync state */
let firebaseApp = null;
let firestoreDb = null;
let syncDocRef = null;
let unsubscribeListener = null;

/* Helpers */
function detectIcon(urlOrName){
  const s = (urlOrName||'').toLowerCase();
  if(s.includes('facebook')) return 'https://cdn-icons-png.flaticon.com/512/733/733547.png';
  if(s.includes('instagram')) return 'https://cdn-icons-png.flaticon.com/512/2111/2111463.png';
  if(s.includes('twitter') || s.includes('x.com')) return 'https://cdn-icons-png.flaticon.com/512/733/733579.png';
  if(s.includes('youtube')) return 'https://cdn-icons-png.flaticon.com/512/1384/1384060.png';
  if(s.includes('tiktok')) return 'https://cdn-icons-png.flaticon.com/512/3046/3046121.png';
  return 'https://cdn-icons-png.flaticon.com/512/565/565547.png';
}
function normalizeUrl(u){ if(!u) return ''; u=u.trim(); if(u.startsWith('http')) return u; return 'https://'+u; }

/* Render helpers */
function appendSocialDom(name,url,icon){
  const item = document.createElement('div');
  item.className = 'social-item';
  item.innerHTML = `<img src="${icon}" alt="${name}"><a href="${url}" target="_blank" rel="noopener noreferrer"><span class="sname">${name}</span></a>`;
  socialList.appendChild(item);
}

/* Save local state to localStorage */
function saveLocal(){
  const socials = Array.from(document.querySelectorAll('.social-item')).map(it=>{
    return { name: it.querySelector('.sname').innerText, url: it.querySelector('a').href, icon: it.querySelector('img').src };
  });
  const data = { about: aboutText.innerText, contact: contactText.innerHTML, profilePic: profilePic.src || '', socials };
  localStorage.setItem('portfolio_data_local', JSON.stringify(data));
}

/* Load from localStorage */
function loadLocal(){
  const raw = localStorage.getItem('portfolio_data_local');
  if(!raw) return;
  try{
    const d = JSON.parse(raw);
    aboutText.innerText = d.about || aboutText.innerText;
    contactText.innerHTML = d.contact || contactText.innerHTML;
    profilePic.src = d.profilePic || profilePic.src;
    socialList.innerHTML = '';
    (d.socials||[]).forEach(s=>appendSocialDom(s.name, s.url, s.icon));
  }catch(e){ console.error(e); }
}

/* Sync helpers - will be set when user supplies Firebase config */
function setSyncConnected(status){
  syncStatus.textContent = status;
  syncStatus.style.color = status.includes('Connected') ? 'green' : 'var(--muted)';
}

/* Connect to Firebase (user provides config JSON) */
async function connectFirebaseFromPrompt(){
  const txt = prompt('Paste your Firebase config object (JSON).\\nExample: { "apiKey":"...", "authDomain":"...", "projectId":"..."}');
  if(!txt) return;
  let cfg;
  try{ cfg = JSON.parse(txt); } catch(e){ alert('Invalid JSON'); return; }
  try{
    // load SDKs dynamically
    await loadScript('https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js');
    await loadScript('https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js');
    firebaseApp = firebase.initializeApp(cfg);
    firestoreDb = firebase.firestore();
    syncDocRef = firestoreDb.collection('portfolio').doc('profile');
    localStorage.setItem('portfolio_firebase_cfg', JSON.stringify(cfg));
    setSyncConnected('Connected (Realtime)');
    attachRealtimeListener();
    const snap = await syncDocRef.get();
    if(!snap.exists){
      await syncDocRef.set(getCurrentState());
    } else {
      applyRemoteState(snap.data());
    }
    alert('Connected to Firebase successfully.');
  }catch(err){
    console.error(err);
    alert('Failed to connect Firebase: ' + (err.message||err));
  }
}

/* Load Firebase config from localStorage if previously saved */
async function tryAutoConnectFirebase(){
  const raw = localStorage.getItem('portfolio_firebase_cfg');
  if(!raw) return;
  try{
    const cfg = JSON.parse(raw);
    await loadScript('https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js');
    await loadScript('https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js');
    firebaseApp = firebase.initializeApp(cfg);
    firestoreDb = firebase.firestore();
    syncDocRef = firestoreDb.collection('portfolio').doc('profile');
    setSyncConnected('Connected (Realtime)');
    attachRealtimeListener();
  }catch(e){ console.warn('Auto Firebase connect failed', e); }
}

/* Load JS file dynamically */
function loadScript(src){ return new Promise((res,rej)=>{ const s=document.createElement('script'); s.src=src; s.onload=res; s.onerror=rej; document.head.appendChild(s); }); }

/* Real-time listener */
function attachRealtimeListener(){
  if(!syncDocRef) return;
  if(unsubscribeListener) unsubscribeListener();
  unsubscribeListener = syncDocRef.onSnapshot(doc=>{
    if(!doc.exists) return;
    const data = doc.data();
    applyRemoteState(data);
    setSyncConnected('Connected (Realtime)');
  }, err=>{
    console.error(err);
    setSyncConnected('Error');
  });
}

/* Apply remote state to UI (and save locally) */
function applyRemoteState(d){
  if(!d) return;
  if(d.about) aboutText.innerText = d.about;
  if(d.contact) contactText.innerHTML = d.contact;
  if(d.profilePic) profilePic.src = d.profilePic;
  socialList.innerHTML = '';
  (d.socials||[]).forEach(s=>appendSocialDom(s.name, s.url, s.icon));
  saveLocal();
}

/* Build object from UI */
function getCurrentState(){
  const socials = Array.from(document.querySelectorAll('.social-item')).map(it=>({
    name: it.querySelector('.sname').innerText,
    url: it.querySelector('a').href,
    icon: it.querySelector('img').src
  }));
  return { about: aboutText.innerText, contact: contactText.innerHTML, profilePic: profilePic.src || '', socials };
}

/* Push current UI to Cloud */
async function pushToCloud(){
  if(!syncDocRef) return alert('Not connected to sync. Use Connect Sync.');
  try{
    await syncDocRef.set(getCurrentState());
    alert('Saved to cloud.');
  }catch(e){ alert('Cloud save failed: '+e.message); }
}

/* UI events - passwords and edit flow */
toggleView.addEventListener('click', ()=>{ viewPassInput.type = viewPassInput.type === 'password' ? 'text' : 'password'; toggleView.textContent = viewPassInput.type === 'password' ? 'Show' : 'Hide'; });
enterView.addEventListener('click', async ()=>{
  const hv = await hash(viewPassInput.value || '');
  if(hv === VIEW_HASH){
    passwordScreen.style.display = 'none';
    mainContent.classList.remove('hidden');
    // show edit button (but editing requires edit password)
    loadLocal();
    tryAutoConnectFirebase();
  } else {
    viewMsg.textContent = 'Incorrect password';
    setTimeout(()=>viewMsg.textContent='',2000);
  }
});

/* Edit mode */
editBtn.addEventListener('click', async ()=>{
  const p = prompt('Enter edit password:');
  if(!p) return;
  if(await hash(p) !== EDIT_HASH){ alert('Wrong edit password'); return; }
  isEditing = true;
  uploadPicBtn.classList.remove('hidden');
  addSocialBtn.classList.remove('hidden');
  removeSocialBtn.classList.remove('hidden');
  doneBtn.classList.remove('hidden');
  editBtn.classList.add('hidden');
  aboutText.contentEditable = true;
  contactText.contentEditable = true;
});

/* Done editing */
doneBtn.addEventListener('click', async ()=>{
  isEditing = false;
  uploadPicBtn.classList.add('hidden');
  addSocialBtn.classList.add('hidden');
  removeSocialBtn.classList.add('hidden');
  doneBtn.classList.add('hidden');
  editBtn.classList.remove('hidden');
  aboutText.contentEditable = false;
  contactText.contentEditable = false;
  saveLocal();
  if(syncDocRef) await pushToCloud();
});

/* Upload picture */
uploadPicBtn.addEventListener('click', ()=>{
  const inp = document.createElement('input'); inp.type = 'file'; inp.accept = 'image/*';
  inp.onchange = e=>{
    const file = e.target.files[0]; if(!file) return;
    const reader = new FileReader(); reader.onload = ev=>{ profilePic.src = ev.target.result; saveLocal(); if(syncDocRef) pushToCloud(); };
    reader.readAsDataURL(file);
  };
  inp.click();
});

/* Add social */
addSocialBtn.addEventListener('click', ()=>{
  const name = prompt('Social name (e.g. Facebook):'); if(!name) return;
  let url = prompt('URL (include https:// or domain):'); if(!url) return;
  url = normalizeUrl(url);
  appendSocialDom(name, url, detectIcon(name));
  saveLocal();
  if(syncDocRef) pushToCloud();
});

/* Remove social */
removeSocialBtn.addEventListener('click', ()=>{
  socialSelect.innerHTML = '';
  document.querySelectorAll('.social-item .sname').forEach(s=>{
    const opt = document.createElement('option'); opt.value = s.innerText; opt.textContent = s.innerText; socialSelect.appendChild(opt);
  });
  removeMenu.style.display = 'block';
});
cancelRemoveBtn.addEventListener('click', ()=> removeMenu.style.display = 'none');
confirmRemoveBtn.addEventListener('click', ()=>{
  const val = socialSelect.value;
  document.querySelectorAll('.social-item').forEach(it=>{
    if(it.querySelector('.sname').innerText === val) it.remove();
  });
  saveLocal();
  if(syncDocRef) pushToCloud();
  removeMenu.style.display = 'none';
});

/* Connect sync button - prompt for firebase config and connect */
connectSyncBtn.addEventListener('click', connectFirebaseFromPrompt);

/* Try load local on start (but keep password screen until unlocked) */
loadLocal();

/* Expose a helper to clear local cache (for debugging) */
window._clearLocal = ()=>{ localStorage.removeItem('portfolio_data_local'); localStorage.removeItem('portfolio_firebase_cfg'); alert('Local storage cleared.'); };
</script>
</body>
</html>
